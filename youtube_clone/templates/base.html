{% load static i18n compress%}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>
    {% block title %}
    youtube_clone
    {% endblock title %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Youtube clone test" />
  <meta name="author" content="Wilmer Montilla" />
  <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}" />
  {% block css %}
  <!-- Latest compiled and minified Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
    integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Your stuff: Third-party CSS libraries go here -->
  <!-- This file stores project-specific CSS -->


  {% compress css %}
  <link href="{% static 'css/project.css' %}" rel="stylesheet" />
  {% endcompress %}


  {% endblock css %}
  <!-- Le javascript
    ================================================== -->
  {# Placed at the top of the document so pages load faster with defer #}
  {% block javascript %}


  <!-- Bootstrap JS -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"
    integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Your stuff: Third-party javascript libraries go here -->


  <!-- place project specific Javascript in this file -->


  {% compress js %}
  <script defer src="{% static 'js/project.js' %}"></script>
  {% endcompress %}

  <script>
    const logoutLink = document.getElementById('sign-out');
    if (logoutLink) {
      logoutLink.addEventListener('click', async (event) => {
        event.preventDefault();

        const refreshToken = localStorage.getItem('refreshToken');

        if (!refreshToken) {
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          window.location.href = '/sign-in';
          return;
        }

        try {
          const response = await fetch('/api/users/auth/sign-out/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ refresh: refreshToken })
          });

        } catch (error) {
          console.error('Error during logout request:', error);
        } finally {
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          window.location.href = '/sign-in';
        }
      });
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
        document.getElementById('user-email').textContent = "Videos";
        return;
      }

      try {
        const response = await fetch('/api/users/me/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (response.status === 200) {
          const data = await response.json();

          document.getElementById('user-email').textContent = data.email ?? "User";
        }

        else if (response.status === 401) {
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
        } else {
          console.error('Error al obtener los datos del usuario:', response.statusText);
        }
      } catch (error) {
        console.error('Ocurri√≥ un error en la solicitud:', error);
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const currentPath = window.location.pathname;
      const navLinks = document.querySelectorAll('.nav-pills .nav-link');
      navLinks.forEach(link => {
        const linkPath = link.getAttribute('href');
        link.classList.remove('active');
        link.classList.remove('text-white');
        if (currentPath === linkPath) {
          link.classList.add('active');
        } else {
          link.classList.add('text-white');
        }
      });
      if (currentPath === '/') {
        const homeLink = document.querySelector('.nav-pills .nav-link[href="/"]');
        if (homeLink) {
          homeLink.classList.add('active');
          homeLink.classList.remove('text-white');
        }
      }
    });
  </script>
  {% endblock javascript %}
</head>

<body class="{% block bodyclass %}{% endblock bodyclass %}">
  {% block body %}
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">YouTube Clone</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active text-white" aria-current="page" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/sign-in">login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" id="sign-out" href="#">logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="d-flex flex-row">
  <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width: 280px; height: 100vh;">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
      <svg class="bi me-2" width="40" height="32">
        <use xlink:href="#bootstrap"></use>
      </svg>
      <span class="fs-4" id="user-email">loading...</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a href="/" class="nav-link active" aria-current="page">
          <svg class="bi me-2" width="16" height="16">
            <use xlink:href="/"></use>
          </svg>
          Home
        </a>
      </li>
      <li>
        <a href="/upload-video" class="nav-link text-white">
          <svg class="bi me-2" width="16" height="16">
            <use xlink:href="#speedometer2"></use>
          </svg>
          Upload video
        </a>
      </li>
      <li>
        <a href="#" class="nav-link text-white">
          <svg class="bi me-2" width="16" height="16">
            <use xlink:href="#table"></use>
          </svg>
          History
        </a>
      </li>
      <li>
        <a href="#" class="nav-link text-white">
          <svg class="bi me-2" width="16" height="16">
            <use xlink:href="#grid"></use>
          </svg>
          Popular
        </a>
      </li>
    </ul>
    <hr>
  </div>

    {% block content %}
    {% endblock content %}

  {% endblock body %}
</body>

</html>
