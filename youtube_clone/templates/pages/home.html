{% extends "base.html" %}

{% block content %}
  <!-- Main content -->
  <div class="flex-grow-1 p-4">
    <h1>Videos</h1>
    {% csrf_token %}
    <div class="row" id="video-container">
      <p>Loading...</p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/videos/random/');
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const videos = await response.json();
        const container = document.getElementById('video-container');
        container.innerHTML = '';

        if (videos.length === 0) {
          container.innerHTML = '<p>No videos found.</p>';
          return;
        }

        videos.forEach(video => {
          const uploaderName = video.uploader ? (video.uploader.name || video.uploader.email) : 'Unknown';
          const detailUrl = `/videos/${video.id}/`;
          const videoCardHTML = `
              <div class="col-md-4 mb-4">
                <div class="card">
                  <div class="card-body">
                    <div class="ratio ratio-16x9">
                      <iframe width="560" height="315" src="${video.embed_url}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <h5 class="card-title py-2">${video.title}</h5>
                    <p class="card-text">
                      <strong>Posted by:</strong> ${uploaderName}<br>
                      <strong>Date:</strong> ${new Date(video.upload_date).toLocaleDateString()}
                    </p>
                    <a href="${detailUrl}" class="btn btn-primary view-details-btn" id="button-detail-${video.id}" data-video-id="${video.id}">View Details</a>
                  </div>
                </div>
              </div>
            `;
          // 4. AÃ±ade la tarjeta de video al contenedor
          container.innerHTML += videoCardHTML;
        });

      } catch (error) {
        console.error('Failed to fetch videos:', error);
        document.getElementById('video-container').innerHTML = '<p>Could not load videos. Please try again later.</p>';
      }
    });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const videoGrid = document.getElementById('video-container');

    videoGrid.addEventListener('click', async (event) => {
      const clickedButton = event.target.closest('.view-details-btn');

      if (clickedButton) {
        event.preventDefault();

        const videoId = clickedButton.dataset.videoId;
        const accessToken = localStorage.getItem('accessToken');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (accessToken && videoId) {
          try {
            await fetch('/api/videos/history/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`,
                'X-CSRFToken': csrfToken
              },
              body: JSON.stringify({ video_id: videoId })
            });
          } catch (error) {
            console.error('No se pudo registrar el video en el historial:', error);
          }
        }
        window.location.href = clickedButton.href;
      }
    });

  });
  </script>

  {% endblock content %}
