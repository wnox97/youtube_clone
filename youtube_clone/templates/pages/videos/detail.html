{% extends 'base.html' %}


{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">

      <!-- 1. Contenedor del Video -->
      <div class="ratio ratio-16x9 mb-3">
        <iframe id="video-player" src="" title="Video Player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
        </iframe>
      </div>

      <!-- 2. Título del Video -->
      <h1 class="h4 mb-3" id="video-title">Cargando título...</h1>

      <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center me-3 mb-2 mb-md-0">
          <div>
            <h6 id="uploader-name" class="mb-0">Cargando...</h6>
          </div>
        </div>
      </div>

      <!-- 4. Botones de Acción: Like/Dislike -->
      <div class="d-flex align-items-center mb-3">
        <!-- Botón de Like -->
        <button type="button" class="btn btn-light border me-2" id="like-btn">
          <i class="fas fa-thumbs-up"></i>
          <span class="ms-2" id="like-count">0</span>
        </button>

        <!-- Botón de Dislike -->
        <button type="button" class="btn btn-light border" id="dislike-btn">
          <i class="fas fa-thumbs-down"></i>
          <span class="ms-2" id="dislike-count">0</span>
        </button>
      </div>

      <div class="bg-light p-3 rounded mb-4">
        <p class="fw-bold"><span id="view-count">0</span> vistas &nbsp;&nbsp; <span id="upload-date"></span></p>
        <p id="video-description">Cargando descripción...</p>
      </div>

      <hr>
      <h4 class="mb-3">Comentarios (<span id="comment-count">0</span>)</h4>

      <div class="d-flex align-items-start mb-4">
        <div class="w-100">
          <form id="comment-form">
            {% csrf_token %}
            <textarea id="comment-text" class="form-control" rows="2" placeholder="Añadir un comentario..."></textarea>
            <div class="d-flex justify-content-end mt-2">
              <button type="button" class="btn btn-secondary btn-sm me-2">Cancelar</button>
              <button type="submit" class="btn btn-primary btn-sm">Comentar</button>
            </div>
          </form>
        </div>
      </div>

      <div id="comments-list">
        <p id="placeholder-comments">Cargando comentarios...</p>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const path = window.location.pathname;
    const pathSegments = path.split('/');
    const videoId = pathSegments[2];
    const accessToken = localStorage.getItem('accessToken');

    if (!videoId) {
      console.error("No se pudo encontrar el ID del video en la URL.");
      document.getElementById('video-title').textContent = 'URL de video no válida.';
      return;
    }

    try {
      const response = await fetch(`/api/videos/${videoId}/`);
      const responseComment = await fetch(`/api/videos/${videoId}/comments/`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`,
        },
      });

      if (!responseComment.ok) {
        console.error('Error al cargar los comentarios:', responseComment.statusText);
        document.getElementById('comments-list').innerHTML = '<p>Error al cargar los comentarios.</p>';
        return;
      }

      if (!response.ok) {
        document.body.innerHTML = '<h1>Video no encontrado</h1>';
        return;
      }
      const videoData = await response.json();
      const commentsData = await responseComment.json();

       const commentsContainer = document.getElementById('comments-list');
       commentsContainer.innerHTML = '';
       const commentsCount = document.getElementById('comment-count');
      commentsCount.textContent = commentsData.length;

      document.getElementById('video-player').src = videoData.embed_url;
      document.getElementById('video-title').textContent = videoData.title;

      if (videoData.uploader) {
        document.getElementById('uploader-name').textContent = videoData.uploader.name || videoData.uploader.email;
      }

      document.getElementById('video-description').textContent = "Esta es una descripción de ejemplo. Añade un campo de descripción a tu modelo Video.";
      const uploadDate = new Date(videoData.upload_date);
      document.getElementById('upload-date').textContent = uploadDate;

      if (commentsData.length === 0) {
        commentsContainer.innerHTML = '<p>No hay comentarios todavía. ¡Sé el primero en comentar!</p>';
        return;
      }

      commentsData.forEach(comment => {
        const userName = comment.user ? (comment.user.name || comment.user.email) : 'Anónimo';
        const commentDate = new Date(comment.created_at).toLocaleDateString();

        const commentHTML = `
        <div class="d-flex align-items-start mb-3">
          <div>
            <h6 class="mb-0">${userName} <small class="text-muted ms-2">${commentDate}</small></h6>
            <p class="mb-1">${comment.text}</p>
          </div>
        </div>
      `;
        commentsContainer.innerHTML += commentHTML;
      });


    } catch (error) {
      console.error('Error al cargar los datos del video:', error);
      document.getElementById('video-title').textContent = 'Error al cargar el video.';
    }
  });
</script>

<script>
  const commentForm = document.getElementById('comment-form');

  commentForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const videoId = window.location.pathname.split('/')[2];
    const commentText = document.getElementById('comment-text').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const accessToken = localStorage.getItem('accessToken');

    if (!accessToken) {
      alert('Debes iniciar sesión para poder comentar.');
      window.location.href = '/sign-in';
      return;
    }

    if (!commentText.trim()) {
      alert('El comentario no puede estar vacío.');
      return;
    }

    try {
      const response = await fetch(`/api/videos/${videoId}/comments/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`,
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text: commentText })
      });

      if (response.ok) {
        document.getElementById('comment-text').value = '';
        alert('Comentario publicado con éxito.');
        location.reload();
      } else {
        const errorData = await response.json();
        console.error('Error al publicar el comentario:', errorData);
        alert('No se pudo publicar el comentario. Por favor, inténtalo de nuevo.');
      }
    } catch (error) {
      console.error('Error de red:', error);
      alert('Ocurrió un error de red. Por favor, revisa tu conexión.');
    }
  });

</script>

<script>
  function updateLikeCounts(likes, dislikes) {
    document.getElementById('like-count').textContent = likes;
    document.getElementById('dislike-count').textContent = dislikes;
  }

  async function handleVote(videoId, isLike) {
    const accessToken = localStorage.getItem('accessToken');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!accessToken) {
      alert('Debes iniciar sesión para poder votar.');
      window.location.href = '/sign-in';
      return;
    }

    try {
      const voteResponse = await fetch(`/api/video-interactions/${videoId}/vote/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`,
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ is_like: isLike })
      });

      if (!voteResponse.ok) {
        throw new Error('Failed to submit vote');
      }

      const countsResponse = await fetch(`/api/video-interactions/${videoId}/likes-dislikes/`);
      const countsData = await countsResponse.json();

      updateLikeCounts(countsData.likes, countsData.dislikes);

    } catch (error) {
      console.error('Error al procesar el voto:', error);
      alert('Ocurrió un error al procesar tu voto.');
    }
  }
document.addEventListener('DOMContentLoaded', async () => {
  const videoId = window.location.pathname.split('/')[2];
    try {
      const countsResponse = await fetch(`/api/video-interactions/${videoId}/likes-dislikes/`);
      if (countsResponse.ok) {
        const countsData = await countsResponse.json();
        updateLikeCounts(countsData.likes, countsData.dislikes);
      }
    } catch (error) {
      console.error('Error al cargar datos iniciales:', error);
    }

    document.getElementById('like-btn').addEventListener('click', () => {
      handleVote(videoId, true);
    });

    document.getElementById('dislike-btn').addEventListener('click', () => {
      handleVote(videoId, false);
    });
  });
</script>
{% endblock %}
